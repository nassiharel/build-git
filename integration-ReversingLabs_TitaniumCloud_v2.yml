category: Data Enrichment & Threat Intelligence
commonfields:
  id: ReversingLabs TitaniumCloud v2
  version: -1
configuration:
- defaultvalue: https://data.reversinglabs.com
  display: ReversingLabs TitaniumCloud URL
  name: base
  required: true
  type: 0
- display: Credentials
  name: credentials
  required: true
  type: 9
- defaultvalue: C - Fairly reliable
  display: Reliability
  name: reliability
  options:
  - A+ - 3rd party enrichment
  - A - Completely reliable
  - B - Usually reliable
  - C - Fairly reliable
  - D - Not usually reliable
  - E - Unreliable
  - F - Reliability cannot be judged
  required: false
  type: 15
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 5.5.0
    itemVersion: 2.0.3
    packID: ReversingLabs_Titanium_Cloud
    packName: ReversingLabs TitaniumCloud
    packPropagationLabels:
    - all
    propagationLabels: []
    toServerVersion: ""
description: ReversingLabs TitaniumCloud provides threat analysis data from various
  ReversingLabs cloud services.
detaileddescription: |-
  ### Partner Contributed Integration
  #### Integration Author: ReversingLabs
  Support and maintenance for this integration are provided by the author. Please use the following contact details:
  - **Email**: [support@reversinglabs.com](mailto:support@reversinglabs.com)
  - **URL**: [https://www.reversinglabs.com/products/malware-analysis-platform](https://www.reversinglabs.com/products/malware-analysis-platform)
  ***
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/reversing-labs-titanium-cloud-v2)
display: ReversingLabs TitaniumCloud v2 (Partner Contribution)
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAAAXNSR0IArs4c6QAADh5JREFUeAHtXAtwVNUZvmc3L4QgDxOSSEJ4SKIoKooWqoIPRHx1fLRW6hSdTtW22Kmv8a1oq7bWWtE62tEqtTKorRYLCjoqoqWiIz5xSMIrJiULBAyvvHfv6ffd3X9zcrl7dyOJaTL7zXx7/vOf/5x77/nP+c9/b1DLSiM9A+kZSM9AegbSM5CegfQMpGeg22dAJRmR7RPBQnAoeDAYAVvBllhZi/IT8EIwFRwCI46zMWa8HGVjTE5UnIuGbDADLAJrwFRQASPe33ngQHAAyDGCIO+/Afwa/Az8L5gIATTMAI8FR4B5IOdhLxgCN4NfghznZDAfJLaAH4O8vkBDWAzaonCV56CeE9O9h3K7q30K6seDI0H6hWgC60E+QxW4BtwDJsQYtDwKsgNvyI8voz0ziY1f/4vR1w/FaPTr79d2H/oelUJ/TvYH4DUgnWmCE14N+l1H2rgh3jJsX4I8zKiL3RXQJQIXjNhxUQm+A+FzUNr8yvnSyf0w1E8GuSPngoeCPYF9xqDcnX4w28N+hgfQRsecAD4C/hNknWD0egEcxUo34h6MxWiSKqbBcAXIxdolMFyZ4IMtBAcbyg2QGWY2gQxr7eCPwCPARHgXDeyTCIejYWascRZKLrREIct08GrYnRTrx2IZWGnU3eIqtwL1P4C7QD47j4tykGNmg8T5IHfY0+CVIEM7wR3DnfEauBPkPbONZMguAGmTCkbC6FqQESYZsmDwV1DCNu2/Ap8Hudt3g4ygB4GDQPruI9ATU6HlTQrvh8zzyg2eIWLzMmReQOosrwP9MAONpj3Djxe4ynm+iO3thkzdJWAycNVLf5bjPDrQhme12L0ds+EZKLoXYrpkRSohmmPSMVwYbtBpck3O0xyjTv1vQffGhMobXIUmuJoFDKOc0IgourFcibGYoAjMXSo6lmeAdLLgdRG6ufwC43HHCsbHhCGiQMmFdqAIY4CtsUG40+5MYcCzDJuNkG8FOU5KcDuYFxUwHPeEczl+G7icQgxMZLxg6hmKN3kZdZPOdCBDHcGMVHAphEQLUWySlZzvBwyjqyAfZtS9xOMM5auQbaOeVHQ7uM7owfOpyKh3t7jEGPAYyCONuoimg5eKsofKI41xt8TkBYYuGzLv+R3wQjDlMAlbAef7L6CMnwmZIdcP9INgvQjftORq4gqRM4Dna47HYMnOYC6Uz3zImx4OMtTItbiaTdDp0sZyGsg+po7Jht91eO+pnMEnwa7ZGHsBZMHfIJjXFJnPeBc4VAxj5VsoxeYlyMOMOvWMDj916aaiLnCfwaY/5ojRgZSvoLPcIMvdIG/0MfB+8PcgzwKx8UqypC1RWYj+xLug2Jg7mm23G21fQ+aOcTtY+iYqmVm6HfwodLeB80C+Fv0bNCeRbwlHgwIF4U6wEfS6DufnBlCQzME8BvksFaCM9x/pjNLtYLFheZlhJyIXEEO3SfdmEVunZGLxIWgO7Cd7OZiTsdOH/BpEcGJkbJ6BZkK12mhbCJlwO3gvdH7X8XKwXM+r5D0kyswL0Mbzsx706vsU9EQqDqYdw7w5zkVUAl11MI9RcxzK8zmQH/hqxBt2d/Sqezn4Or/BjbYy1zXkzM2HPmK0McEh3A5O5IyodfTXvYO9noE6hugxZscEchb0vJ81oHusU6FL1cEwtcxFzISOO5uhX8adAbnNqF8B2Q1uFr7i8f6lX9zB7iRLOmdCOF0qKNeCk8ApIM+L18HuQCUG4YMJJEs9Gwq5tzDkZWLQDSUnaSZIZ8wDBTyvz5OKT8kJXwQeD97qsvuxq56sepNhcBhk3huf1wS/lwsOFsEot0EuBrmw9oNMoruBO7DUUM6F/AnIFfc+uAPsLiwxBjorJkvJKs/IXTF9dxQc7w3wHfDXIJ9LcBcERolUwN1yP2gu0NJUOho2KyG/ZtRvhsydaGKLUZlgyCmJXg4uRM9bjN4LIfNGegr/MgYuhczVeIqhMxeAoe4WkcnVL0A6ixgK3uNIqf8w3xBEROhCybnmfRBjwPGO1PHzXodofQ8y84qU4eVgrkqm8sRe8EZH6rmfVRiaWbLgEghcZIKlIvRQyYi0wBj7Ksip7pSTYcszXsAI11V8jg7cRInwD6MhDzI/mRYZOl+Rh7oJnivmOcKQFTINUpRvh90vfWx50zfE2rnqecbyDxjEz6OF88vwZ4ZAo8kRH8Xv79xKo/4YZPOLmdHUSeRZeAHIN4gg+DA4A5wLzgHrQS72lhhzUHK3fRdUIMHXKyacU1jpIu6A/Q/AbI9+3MFvgGfG2s5FWQl+BH4FtoJ8+zgO3A9uBzP7khteC5kT+E3AUEcmwiGuBoZpcfBoo22JIXuJXNF+8LsHsx8deBvIBUGcAZ4PDge56FPBr2D0cSqGHjZ01OMgx/DCbChXghJZBkGeDiaF6WCujMNAPiwxF3RndE4DftrA5liFK4iQerTm/8vVboK7bC9o3g/bzfOZdZ6VB3IdjpEIT6Dhh2B5zOAmlM+BvB53SCKsQMM94Dsxg10oZQ53Q3bfM+teuBfKC0DzjOU8EzvByeDN4JVgAZgILWiIR13ZrYmM+4ueYVcQT4T0vHmBhmeX5A4N5LeoDctkoYqdlJyjQ8EikJGHzubC566rBunQbxsjcMESsBjk/XER7gDp2C2gJG3xcAzdgSFUUvZ3LM1MjhLQ1tMFtZXu3ZfwAnr69Iytm0KLpL8YqoD6Y2F1xUqp15eV5YabnCQDq1wPgH22shSdZ2uld+NJuWPwoMEVA3Mirw2uquJDx7Fz3ImDW1t3zVaKeYYeg711CMYQ5zdDX6e12oAOi4tqK5+Id+zDgjskfuNH0ZY+DxPmJAlYPu92ZaBtm0OnaK0v3q9PxMmu4w7OViqr3bJnmXa4brSKIiahHrm8sdmy60rGP1WYlztXrVnTvnvChGFNexs+RONY3WFoDjUA+rEYZayl4GrL6hcODphP2FuyrZ2Exrk85rYufh9Kn8MwGq+7BcUMUjUhDrXAI53chkoAmiu31u/j2WY17Wl/MurA2CBKtcGNX6LfavTHxw5VhWuHEBES5R3uq/eJerft4AN5WoXdH/eO0vcqreZjZ2bAIfnbn3n+RIz9vuf4weCZRZvXxaPFnvLy4U1N1hRt2fPRd0ysz9V63Kw7Qm0bT5MlAMcuzRhgzc6rrGJi1wmIJGpHefmgTso+XOl1B4dKjpigdVicAR9krbBU++cQJnFeI9Hd7e1g18QPrqhgtrk0NOpw29KRV9kMh+U22DWTMd4QMccCejKvsnI/57Idu5hrzbNN+velMnH4+5aeQlnhjg/8SjUUVn9RAQfEHaosu6M9xXtSQV1rmrZHIvHMmXod6PT3XtO038m97mBtKX5QiEJby5wdFLCd3UclQu2EbSVHxXd4zNK30LaOf5zAGRvJUjnrUDI7jsLWdyEBu4+Jl6j6a9mrDt46dmI+PMgz1gGyIufVqiBz7NtIdvaJXlttHYtAlCgDYXtIaNyxeWR9cVnR9lFHHFtXPP5abTv/9jlqqdTiodWf7tJK3S1dEYODCNm3NO4J14aKy54OjZ5wgrT1t7JXHawjrec42S5mFTu3PSszdzknOPrRQb8hkw0bzzCNg/YV3dq4nWy39JawHeanwoewaJxPlBjzo4E5+mqOU1RT+ZxSgbiTo2Prg5DMXaHD7R/UlZSt2lZaPjOq7z+/vezgjtcjTPTKYZvW8ENFFCrQ8aFEW6c0lB4TT5LExK9ESNaIAs/mVlYy8XJQWFMxL6iCM9DG9+HO0HpqJGIvrysuW6hLp/OPCf0CvZZFcxK3RkIzmLI60Grf1lFlP4lXteZnQQd8ZWq1Wmbh81V8VzsNSj2MpNc5W5GYZWKsQoTeU2E/GbLS2n4kVFp+MGx/Ex0J/2lgzbo3Ib8J/TQdsa9C6LgIOz5L2rEuZocidVgD1uwOXd+V+CDdAiQtLZjc7Nhg1xfVVj3kNzBeZc7WdvRVxs/OaFs0aGDgmn2Ndsfnx4zgNPM9WGxDxeMfhIOvj9ZVU3b2kMLhGz7YI+1myfPbam28Cbpr0ceJaM7uzwpOLNi4bq1p2xflXgvRStueiVPCSVTWLNXeLt+NE5qxIZiVaXxm1AdFWvcenahD4YZP6gtrq27QKvAzseHut8J2PPkTfV8seyVE82sR/jhxbnzClFqDhGhRvC6CtifiNQl/GADwoaIxkjGFQjLYlt3pDNVBG9HdHwMCOS82R5r+LFa4x5Ei9+WyVxyM8DwJk8Y/wTlQAesx/NXoGalLuW30kSPscNtlEjrx+nOWtPmW7fbpndqVDnWqe1TaVHOJqUbGvd6s91W5RxyMb71HY4d+P+GkaJuvRw5w3kUG5qiOjNnoNGLz2m14fVmNJGgq1UioZmJHxxHUkWH1ow4vDAYDmWHLzg7b9lhlI8nSHf/5KiJDXf6cS9fWP/PCJDtghwNha0cwc1DjUDu31bp8etuuBYsHt+rmSZGIfjA+MAQ7oFaZ9b4q91SSlWw+mCg5WTIc8HZhTWXnHWf0Do0quxFfph4wVF0SlQrOKaxZ9ywSr9VYGymdq5iUP+FcvqZLF/o/Ne6tJCv+CoSXmZf95ga7c7Ffe6I2RJFNwYC6jM5NZOOlx4J7sSA/9zqvtr6o67YQjY8K862ASjpeQOs8hNA2HVDORw18eHjJb+LyN61bHyopvxt5bS6cloF/u3Ek+n+FZCv6LzqwRRHCwwjgu3H9BowVUhlqufsVRwWDD+O17DS0j8Y7cwHelfG1S+VgTL4+VaO+PiOQ+Xh+9Zefpvz/8PG78XRbegbSM5CegfQMpGcgPQPpGUjPQHoG0jPQR2fgfwHS81axi2gaAAAAAElFTkSuQmCC
name: ReversingLabs TitaniumCloud v2
script:
  commands:
  - arguments:
    - default: true
      description: File hash
      name: hash
      required: true
    description: Retrieve File Reputation data from TitaniumCloud
    name: reversinglabs-titaniumcloud-file-reputation
    outputs:
    - contextPath: File.MD5
      description: Bad hash found
      type: Unknown
    - contextPath: File.SHA1
      description: Bad hash SHA1
      type: Unknown
    - contextPath: File.SHA256
      description: Bad hash SHA256
      type: Unknown
    - contextPath: DBotScore.Score
      description: The actual score.
      type: Number
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: String
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: String
    - contextPath: ReversingLabs.file_reputation
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: File hash
      name: hash
      required: true
    description: Retrieve AV Scanner data from TitaniumCloud.
    name: reversinglabs-titaniumcloud-av-scanners
    outputs:
    - contextPath: File.MD5
      description: Bad hash found
      type: Unknown
    - contextPath: File.SHA1
      description: Bad hash SHA1
      type: Unknown
    - contextPath: File.SHA256
      description: Bad hash SHA256
      type: Unknown
    - contextPath: ReversingLabs.av_scanners
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: File hash
      name: hash
      required: true
    description: Retrieve File Analysis by hash data from TitaniumCloud.
    name: reversinglabs-titaniumcloud-file-analysis
    outputs:
    - contextPath: File.MD5
      description: Bad hash found
      type: Unknown
    - contextPath: File.SHA1
      description: Bad hash SHA1
      type: Unknown
    - contextPath: File.SHA256
      description: Bad hash SHA256
      type: Unknown
    - contextPath: ReversingLabs.file_analysis
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: File hash
      name: hash
      required: true
    - defaultValue: "5000"
      description: Maximum number of results to be returned. Default is 5000.
      name: result_limit
    description: Retrieve a list of functionally similar hashes to the provided one.
    name: reversinglabs-titaniumcloud-rha1-functional-similarity
    outputs:
    - contextPath: ReversingLabs.functional_similarity
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: File hash
      name: hash
      required: true
    description: Retrieve the number of hashes functionally similar to the provided
      one grouped by classification.
    name: reversinglabs-titaniumcloud-rha1-analytics
    outputs:
    - contextPath: File.SHA1
      description: File SHA1
      type: Unknown
    - contextPath: File.SHA256
      description: File SHA256
      type: Unknown
    - contextPath: File.MD5
      description: File MD5
      type: Unknown
    - contextPath: DBotScore.Score
      description: The actual score.
      type: Number
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: String
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: String
    - contextPath: ReversingLabs.rha1_analytics
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: URI string
      name: uri
      required: true
    description: Retrieve the number of MALICIOUS, SUSPICIOUS and KNOWN files associated
      with a specific URI.
    name: reversinglabs-titaniumcloud-uri-statistics
    outputs:
    - contextPath: IP.Address
      description: IP address
      type: Unknown
    - contextPath: Domain.Name
      description: Domain name
      type: Unknown
    - contextPath: URL.Data
      description: The URL
      type: Unknown
    - contextPath: Email.To
      description: Destination email address
      type: Unknown
    - contextPath: ReversingLabs.uri_statistics
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: URI string
      name: uri
      required: true
    - defaultValue: "5000"
      description: Maximum number of results to be returned. Default is 5000.
      name: result_limit
    description: Retrieve a list of all available file hashes associated with a given
      URI.
    name: reversinglabs-titaniumcloud-uri-index
    outputs:
    - contextPath: ReversingLabs.uri_index
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: Query string.
      name: query
      required: true
    - defaultValue: "5000"
      description: Maximum number of results to be returned. Default is 5000.
      name: result_limit
    description: Search for hashes using multi-part search criteria.
    name: reversinglabs-titaniumcloud-advanced-search
    outputs:
    - contextPath: ReversingLabs.advanced_search
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: Query string.
      name: query
      required: true
    - description: Search date.
      name: date
    - defaultValue: "5000"
      description: Maximum number of results to be returned Default is 5000.
      name: result_limit
    description: Search provides samples first seen on a particular date, filtered
      by search criteria.
    name: reversinglabs-titaniumcloud-expression-search
    outputs:
    - contextPath: ReversingLabs.expression_search
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: File hash.
      name: hash
      required: true
    description: Download files associated with a SHA1, MD5 or SHA256 hash.
    name: reversinglabs-titaniumcloud-file-download
  - arguments:
    - default: true
      description: File entry ID.
      name: entryId
      required: true
    description: Upload a file using a byte stream with a SHA1 hash of the file provided
      in the request.
    name: reversinglabs-titaniumcloud-file-upload
  - arguments:
    - default: true
      description: URL string.
      name: url
      required: true
    description: Return a URL analysis report.
    name: reversinglabs-titaniumcloud-url-report
    outputs:
    - contextPath: URL.Data
      description: The URL
      type: Unknown
    - contextPath: DBotScore.Score
      description: The actual score.
      type: Number
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: String
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: String
    - contextPath: ReversingLabs.url_report
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: URL string.
      name: url
      required: true
    description: Analyze a given URL.
    name: reversinglabs-titaniumcloud-analyze-url
    outputs:
    - contextPath: ReversingLabs.analyze_url
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: Sample SHA-1 hash.
      name: sha1
      required: true
    - description: Desired platform; See the API documentation for possible values.
      name: platform
      required: true
    description: Submit an existing sample for dynamic analysis.
    name: reversinglabs-titaniumcloud-submit-for-dynamic-analysis
    outputs:
    - contextPath: ReversingLabs.detonate_sample_dynamic
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: Sample SHA-1 hash.
      name: sha1
      required: true
    description: Retrieve dynamic analysis results.
    name: reversinglabs-titaniumcloud-get-dynamic-analysis-results
    outputs:
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: Unknown
    - contextPath: ReversingLabs.dynamic_analysis_results
      description: ""
      type: Unknown
  - arguments:
    - default: true
      description: Hash string.
      name: certificate_thumbprint
      required: true
    description: Retrieve certificate analytics.
    name: reversinglabs-titaniumcloud-certificate-analytics
    outputs:
    - contextPath: ReversingLabs.certificate_analytics
      description: ""
      type: Unknown
  dockerimage: demisto/reversinglabs-sdk-py3:2.0.0.25193
  runonce: false
  script: |
    register_module_line('ReversingLabs TitaniumCloud v2', 'start', __line__())
    from typing import Union


    from ReversingLabs.SDK.ticloud import FileReputation, AVScanners, FileAnalysis, RHA1FunctionalSimilarity, \
        RHA1Analytics, URIStatistics, URIIndex, AdvancedSearch, ExpressionSearch, FileDownload, FileUpload, \
        URLThreatIntelligence, AnalyzeURL, DynamicAnalysis, CertificateAnalytics

    VERSION = "v2.0.0"
    USER_AGENT = f"ReversingLabs XSOAR TitaniumCloud {VERSION}"

    TICLOUD_URL = demisto.params().get("base")
    USERNAME = demisto.params().get("credentials", {}).get("identifier")
    PASSWORD = demisto.params().get("credentials", {}).get("password")
    RELIABILITY = demisto.params().get("reliability", "C - Fairly reliable")


    def classification_to_score(classification):
        score_dict = {
            "UNKNOWN": 0,
            "KNOWN": 1,
            "SUSPICIOUS": 2,
            "MALICIOUS": 3
        }
        return score_dict.get(classification, 0)


    def test_module_command():
        mwp = FileReputation(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        try:
            _ = mwp.get_file_reputation(hash_input="6a95d3d00267c9fd80bd42122738e726")
        except Exception as e:
            return_error(str(e))

        result = "ok"
        return_results(result)


    def file_reputation_command():
        mwp = FileReputation(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        hash_value = demisto.getArg("hash")

        try:
            response = mwp.get_file_reputation(hash_input=hash_value)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = file_reputation_output(response_json=response_json, hash_value=hash_value)
        return_results(results)


    def file_reputation_output(response_json, hash_value):
        malware_presence = response_json.get("rl", {}).get("malware_presence")
        if not malware_presence:
            return_error("There is no malware_presence object in the response JSON.")

        classification = malware_presence.get("status")
        reason = malware_presence.get("reason")
        threat_name = malware_presence.get("threat_name")

        md5 = malware_presence.get("md5")
        sha1 = malware_presence.get("sha1")
        sha256 = malware_presence.get("sha256")

        markdown = f"""## ReversingLabs File Reputation for hash {hash_value}\n **Classification**: {classification}
        **Classification reason**: {reason}
        **First seen**: {malware_presence.get("first_seen")}
        **Last seen**: {malware_presence.get("last_seen")}
        **AV scanner hits / total number of scanners**: {malware_presence.get("scanner_match")} / {malware_presence.get(
            "scanner_count")}
        **AV scanner hit percentage**: {malware_presence.get("scanner_percent")}%
        **MD5 hash**: {md5}
        **SHA-1 hash**: {sha1}
        **SHA-256 hash**: {sha256}"""
        if classification.upper() in ("MALICIOUS", "SUSPICIOUS"):
            markdown = f"""{markdown}
            **Threat name**: {threat_name}
            **Threat level**: {malware_presence.get("threat_level")}
            """
        elif classification.upper() == "KNOWN":
            markdown = f"""{markdown}
            **Trust factor**: {malware_presence.get("trust_factor")}
            """
        else:
            markdown = f"""## ReversingLabs File Reputation for hash {hash_value}\n **Classification**: {classification}
            **No references were found for this hash.**
            """

        d_bot_score = classification_to_score(classification)

        dbot_score = Common.DBotScore(
            indicator=sha1,
            indicator_type=DBotScoreType.FILE,
            integration_name='ReversingLabs TitaniumCloud v2',
            score=d_bot_score,
            malicious_description=f"{reason} - {threat_name}",
            reliability=RELIABILITY
        )

        indicator = Common.File(
            md5=md5,
            sha1=sha1,
            sha256=sha256,
            dbot_score=dbot_score
        )

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'file_reputation': response_json},
            readable_output=markdown,
            indicator=indicator
        )

        return results


    def av_scanners_command():
        xref = AVScanners(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )
        hash_value = demisto.getArg("hash")

        try:
            response = xref.get_scan_results(hash_input=hash_value)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = av_scanners_output(response_json=response_json, hash_value=hash_value)
        return_results(results)


    def av_scanners_output(response_json, hash_value):
        sample = response_json.get("rl", {}).get("sample")
        if not sample:
            return_error("There is no sample object in the response JSON.")

        md5 = sample.get("md5")
        sha1 = sample.get("sha1")
        sha256 = sample.get("sha256")

        markdown = f"""## ReversingLabs AV Scan results for hash {hash_value}\n **First scanned on**: {sample.get(
            "first_scanned_on")}
        **First seen on**: {sample.get("first_seen_on")}
        **Last scanned on**: {sample.get("last_scanned_on")}
        **Last seen on**: {sample.get("last_seen_on")}
        **Sample size**: {sample.get("sample_size")} bytes
        **Sample type**: {sample.get("sample_type")}
        **MD5 hash**: {md5}
        **SHA-1 hash**: {sha1}
        **SHA-256 hash**: {sha256}
        **SHA-512 hash**: {sample.get("sha512")}
        **SHA-384 hash**: {sample.get("sha384")}
        **RIPEMD-160 hash**: {sample.get("ripemd160")}
        """

        xref_list = sample.get("xref")

        if xref_list and len(xref_list) > 0:
            latest_xref = xref_list[0]

            xref_results = latest_xref.get("results")

            if len(xref_results) > 0:
                markdown = f"""{markdown}**Scanner count**: {latest_xref.get("scanner_count")}
                **Scanner match**: {latest_xref.get("scanner_match")}
                """

                results_table = tableToMarkdown("Latest scan results", xref_results)
                markdown = f"{markdown}\n{results_table}"

        dbot_score = Common.DBotScore(
            indicator=hash_value,
            indicator_type=DBotScoreType.FILE,
            integration_name='ReversingLabs TitaniumCloud v2',
            score=0,
        )

        indicator = Common.File(
            md5=md5,
            sha1=sha1,
            sha256=sha256,
            dbot_score=dbot_score
        )

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'av_scanners': response_json},
            readable_output=markdown,
            indicator=indicator
        )

        return results


    def file_analysis_command():
        rldata = FileAnalysis(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )
        hash_value = demisto.getArg("hash")

        try:
            response = rldata.get_analysis_results(hash_input=hash_value)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = file_analysis_output(response_json=response_json, hash_value=hash_value)

        file_results = fileResult(
            f'File Analysis report file for hash {hash_value}',
            json.dumps(response_json, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE

        )
        return_results([results, file_results])


    def file_analysis_output(response_json, hash_value):
        sample = response_json.get("rl", {}).get("sample")
        if not sample:
            return_error("There is no sample object in the response JSON.")

        md5 = sample.get("md5")
        sha1 = sample.get("sha1")
        sha256 = sample.get("sha256")

        entries = sample.get("analysis").get("entries")
        if len(entries) == 0:
            return_error("The entries list is empty")

        tc_report = entries[0].get("tc_report")

        file_type = tc_report.get("info").get("file").get("file_type")
        file_subtype = tc_report.get("info").get("file").get("file_subtype")

        rldata_xref = sample.get("xref")

        markdown = f"""## ReversingLabs File Analysis results for hash {hash_value}\n **File type**: {file_type}
        **File subtype**: {file_subtype}
        **Sample type**: {rldata_xref.get("sample_type")}
        **Sample size**: {sample.get("sample_size")} bytes
        **Extended description**: {tc_report.get("story")}
        **First seen**: {rldata_xref.get("first_seen")}
        **Last seen**: {rldata_xref.get("last_seen")}
        **MD5 hash**: {sample.get("md5")}
        **SHA-1 hash**: {sample.get("sha1")}
        **SHA-256 hash**: {sample.get("sha256")}
        **SHA-384 hash**: {sample.get("sha384")}
        **SHA-512 hash**: {sample.get("sha512")}
        **SSDEEP hash**: {sample.get("ssdeep")}
        **RIPEMD-160 hash**: {sample.get("ripemd160")}
        """

        dbot_score = Common.DBotScore(
            indicator=hash_value,
            indicator_type=DBotScoreType.FILE,
            integration_name='ReversingLabs TitaniumCloud v2',
            score=0,
        )

        indicator = Common.File(
            md5=md5,
            sha1=sha1,
            sha256=sha256,
            dbot_score=dbot_score
        )

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'file_analysis': response_json},
            readable_output=markdown,
            indicator=indicator
        )

        return results


    def functional_similarity_command():
        similarity = RHA1FunctionalSimilarity(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )
        hash_value = demisto.getArg("hash")
        limit = demisto.getArg("result_limit")

        try:
            sha1_list = similarity.get_similar_hashes_aggregated(hash_input=hash_value, max_results=int(limit))
        except Exception as e:
            return_error(str(e))

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'functional_similarity': sha1_list},
            readable_output="Full report is returned in a downloadable file"
        )

        file_results = fileResult(
            f'RHA1 Functional Similarity report file for hash {hash_value}',
            json.dumps(sha1_list, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE
        )
        return_results([results, file_results])


    def rha1_analytics_command():
        rha_analytics = RHA1Analytics(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )
        hash_value = demisto.getArg("hash")

        try:
            response = rha_analytics.get_rha1_analytics(hash_input=hash_value)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = rha1_analytics_output(response_json=response_json, hash_value=hash_value)
        return_results(results)


    def rha1_analytics_output(response_json, hash_value):
        rha1_counters = response_json.get("rl", {}).get("rha1_counters")
        if not rha1_counters:
            return_error("There is no rha1_counters object in the response JSON.")

        md5 = demisto.get(rha1_counters, "sample_metadata.md5")
        sha1 = hash_value
        sha256 = demisto.get(rha1_counters, "sample_metadata.sha256")

        sample_counters = rha1_counters.get("sample_counters")
        sample_metadata = rha1_counters.get("sample_metadata")
        classification = sample_metadata.get("classification")
        threat_name = sample_metadata.get("threat_name")

        markdown = f"""## ReversingLabs RHA1 Analytics results for hash {sha1}\n ### Sample counters\n **KNOWN**: {
        sample_counters.get("known")}
        **MALICIOUS**:  {sample_counters.get("malicious")}
        **SUSPICIOUS**: {sample_counters.get("suspicious")}
        **TOTAL**:    {sample_counters.get("total")}\n ### Sample metadata\n **Classification**: {classification}
        **MD5 hash**: {md5}
        **SHA-256 hash**: {sha256}
        **First seen**: {sample_metadata.get("first_seen")}
        **Last seen**: {sample_metadata.get("last_seen")}
        **Sample available**: {sample_metadata.get("sample_available")}
        **Sample size**: {sample_metadata.get("sample_size")} bytes
        **Sample type**: {sample_metadata.get("sample_type")}"""
        if classification.upper() in ("MALICIOUS", "SUSPICIOUS"):
            markdown = f"""{markdown}
            **Threat name**: {threat_name}
            **Threat level**: {sample_metadata.get("threat_level")}"""
        else:
            markdown = f"""{markdown}
            **Trust factor**: {sample_metadata.get("trust_factor")}"""

        d_bot_score = classification_to_score(classification)

        dbot_score = Common.DBotScore(
            indicator=sha1,
            indicator_type=DBotScoreType.FILE,
            integration_name='ReversingLabs TitaniumCloud v2',
            score=d_bot_score,
            malicious_description=threat_name,
            reliability=RELIABILITY
        )

        indicator = Common.File(
            md5=md5,
            sha1=sha1,
            sha256=sha256,
            dbot_score=dbot_score
        )

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'rha1_analytics': response_json},
            readable_output=markdown,
            indicator=indicator
        )

        return results


    def uri_statistics_command():
        uri_stats = URIStatistics(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )
        uri = demisto.getArg("uri")

        try:
            response = uri_stats.get_uri_statistics(uri_input=uri)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = uri_statistics_output(response_json=response_json, uri=uri)
        return_results(results)


    def uri_statistics_output(response_json, uri):
        uri_state = response_json.get("rl", {}).get("uri_state")
        if not uri_state:
            return_error("There is no uri_state object in the response JSON.")

        counters = uri_state.get("counters")
        uri_type = uri_state.get("uri_type")
        uri_types = {
            "domain": f"**Domain**: {uri}",
            "url": f"**URL**: {uri}",
            "ipv4": f"**IPv4**: {uri}",
            "email": f"**Email**: {uri}"
        }

        markdown = f"""## ReversingLabs URI Statistics results for URI {uri}\n ### Sample counters\n **KNOWN**: {
        counters.get("known")}
        **MALICIOUS**: {counters.get("malicious")}
        **SUSPICIOUS**: {counters.get("suspicious")}
        **SHA-1 hash**: {uri_state.get("sha1")}
        **URI type**: {uri_type}
        {uri_types.get(uri_type)}"""

        indicator: Union[Common.Domain, Common.URL, Common.IP, Common.EMAIL, None] = None

        if uri_type == "domain":
            indicator = Common.Domain(
                domain=uri,
                dbot_score=Common.DBotScore(
                    indicator=uri,
                    indicator_type=DBotScoreType.DOMAIN,
                    integration_name='ReversingLabs TitaniumCloud v2',
                    score=0,
                )
            )
        elif uri_type == "url":
            indicator = Common.URL(
                url=uri,
                dbot_score=Common.DBotScore(
                    indicator=uri,
                    indicator_type=DBotScoreType.URL,
                    integration_name='ReversingLabs TitaniumCloud v2',
                    score=0,
                )
            )
        elif uri_type == "ipv4":
            indicator = Common.IP(
                ip=uri,
                dbot_score=Common.DBotScore(
                    indicator=uri,
                    indicator_type=DBotScoreType.IP,
                    integration_name='ReversingLabs TitaniumCloud v2',
                    score=0,
                )
            )
        elif uri_type == "email":
            indicator = Common.EMAIL(
                address=uri,
                dbot_score=Common.DBotScore(
                    indicator=uri,
                    indicator_type=DBotScoreType.EMAIL,
                    integration_name='ReversingLabs TitaniumCloud v2',
                    score=0,
                )
            )
        else:
            return_error("This integration does not currently support this URI type")

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'uri_statistics': response_json},
            readable_output=markdown,
            indicator=indicator
        )

        return results


    def uri_index_command():
        uri_index = URIIndex(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        uri = demisto.getArg("uri")
        limit = demisto.getArg("result_limit")

        try:
            sha1_list = uri_index.get_uri_index_aggregated(uri_input=uri, max_results=int(limit))
        except Exception as e:
            return_error(str(e))

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'uri_index': sha1_list},
            readable_output="Full report is returned in a downloadable file"
        )

        file_results = fileResult(
            f'URI Index report file for URI {uri}',
            json.dumps(sha1_list, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE
        )

        return_results([results, file_results])


    def advanced_search_command():
        advanced_search = AdvancedSearch(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        query = demisto.getArg("query")
        limit = demisto.getArg("result_limit")

        try:
            result_list = advanced_search.search_aggregated(query_string=query, max_results=int(limit))
        except Exception as e:
            return_error(str(e))

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'advanced_search': result_list},
            readable_output="Full report is returned in a downloadable file"
        )

        file_results = fileResult(
            'Advanced Search report file',
            json.dumps(result_list, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE
        )

        return_results([results, file_results])


    def expression_search_command():
        expression_search = ExpressionSearch(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        query = demisto.getArg("query")
        date = demisto.getArg("date")
        limit = demisto.getArg("result_limit")
        query_list = query.split(" ")

        try:
            result_list = expression_search.search_aggregated(
                query=query_list,
                date=date,
                max_results=int(limit)
            )
        except Exception as e:
            return_error(str(e))

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'expression_search': result_list},
            readable_output="Full report is returned in a downloadable file"
        )

        file_results = fileResult(
            'Expression Search report file',
            json.dumps(result_list, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE
        )

        return_results([results, file_results])


    def file_download_command():
        file_download = FileDownload(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        hash_value = demisto.getArg("hash")

        try:
            response = file_download.download_sample(hash_input=hash_value)
        except Exception as e:
            return_error(str(e))

        results = CommandResults(
            readable_output=f"Requested sample is available for download under the name {hash_value}"
        )

        return_results([results, fileResult(hash_value, response.content)])


    def file_upload_command():
        file_upload = FileUpload(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        file_entry = demisto.getFilePath(demisto.getArg("entryId"))
        filename = file_entry["name"]

        with open(file_entry["path"], "rb") as file_handle:
            _ = file_upload.upload_sample_from_file(file_handle=file_handle, sample_name=filename)

            results = CommandResults(
                readable_output=f"Successfully uploaded file {filename}"
            )

            return_results(results)


    def url_report_command():
        url_ti = URLThreatIntelligence(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        url = demisto.getArg("url")

        try:
            response = url_ti.get_url_report(url_input=url)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = url_report_output(response_json=response_json, url=url)
        return_results(results)


    def url_report_output(response_json, url):
        report_base = response_json.get("rl")

        if not report_base:
            return_error("There is no rl object in the response JSON.")

        classification = report_base.get("classification", "UNAVAILABLE").upper()
        markdown = f"""## ReversingLabs URL Threat Intelligence report for URL {url}\n **Requested URL**: {report_base.get(
            "requested_url")}
        **Classification**: {classification}"""

        analysis = report_base.get("analysis")
        if analysis:
            statistics = analysis.get("statistics")
            analysis_history = analysis.get("analysis_history")
            last_analysis = analysis.get("last_analysis")

            markdown += f"""\n    **First analysis**: {analysis.get("first_analysis")}
            **Analysis count**: {analysis.get("analysis_count")}\n ### Last analysis\n **Analysis ID**: {last_analysis.get(
                "analysis_id")}
            **Analysis time**: {last_analysis.get("analysis_time")}
            **Final URL**: {last_analysis.get("final_url")}
            **Availability status**: {last_analysis.get("availability_status")}
            **Domain**: {last_analysis.get("domain")}
            **Serving IP Address**: {last_analysis.get("serving_ip_address")}\n ### Statistics\n **KNOWN**: {statistics.get(
                "known")}
            **SUSPICIOUS**: {statistics.get("suspicious")}
            **MALICIOUS**: {statistics.get("malicious")}
            **UNKNOWN**: {statistics.get("unknown")}
            **TOTAL**: {statistics.get("total")}"""

            analysis_table = tableToMarkdown("Analysis history", analysis_history)
            markdown = f"{markdown}\n {analysis_table}"

        third_party = report_base.get("third_party_reputations")
        if third_party:
            third_party_statistics = third_party.get("statistics")
            third_party_sources = third_party.get("sources")

            markdown += f"""\n ### Third party statistics\n **TOTAL**: {third_party_statistics.get("total")}
            **MALICIOUS**: {third_party_statistics.get("malicious")}
            **CLEAN**: {third_party_statistics.get("clean")}
            **UNDETECTED**: {third_party_statistics.get("undetected")}\n"""

            sources_table = tableToMarkdown("Third party sources", third_party_sources)
            markdown = f"{markdown}\n {sources_table}"

        d_bot_score = classification_to_score(classification)

        dbot_score = Common.DBotScore(
            indicator=url,
            indicator_type=DBotScoreType.URL,
            integration_name='ReversingLabs TitaniumCloud v2',
            score=d_bot_score,
            malicious_description=classification.upper(),
            reliability=RELIABILITY
        )

        indicator = Common.URL(
            url=url,
            dbot_score=dbot_score
        )

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'url_report': response_json},
            readable_output=markdown,
            indicator=indicator
        )

        return results


    def analyze_url_command():
        analyze_url = AnalyzeURL(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        url = demisto.getArg("url")

        try:
            response = analyze_url.submit_url(url_input=url)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = analyze_url_output(response_json=response_json, url=url)
        return_results(results)


    def analyze_url_output(response_json, url):
        report_base = response_json.get("rl", {})

        markdown = f"""## ReversingLabs Analyze URL response for URL {url}\n **Status**: {report_base.get("status")}
        **Analysis ID**: {report_base.get("analysis_id")}
        **Requested URL**: {report_base.get("requested_url")}"""

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'analyze_url': response_json},
            readable_output=markdown
        )

        return results


    def detonate_sample_command():
        sandbox = DynamicAnalysis(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        sha1 = demisto.getArg("sha1")
        platform = demisto.getArg("platform")

        try:
            response = sandbox.detonate_sample(sample_sha1=sha1, platform=platform)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = detonate_sample_output(response_json=response_json, sha1=sha1)
        return_results(results)


    def detonate_sample_output(response_json, sha1):
        report_base = response_json.get("rl", {})

        markdown = f"""## ReversingLabs submit sample {sha1} for Dynamic Analysis\n **Status**: {report_base.get("status")}
        **Requested hash**: {report_base.get("requested_hash")}
        **Analysis ID**: {report_base.get("analysis_id")}"""

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'detonate_sample_dynamic': response_json},
            readable_output=markdown
        )

        return results


    def dynamic_analysis_results_command():
        sandbox = DynamicAnalysis(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        sha1 = demisto.getArg("sha1")

        try:
            response = sandbox.get_dynamic_analysis_results(sample_hash=sha1, latest=True)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        dbot_score = Common.DBotScore(
            indicator=sha1,
            indicator_type=DBotScoreType.FILE,
            integration_name='ReversingLabs TitaniumCloud v2',
            score=0
        )

        indicator = Common.File(
            sha1=sha1,
            dbot_score=dbot_score
        )

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'dynamic_analysis_results': response_json},
            readable_output="Full report is returned in a downloadable file",
            indicator=indicator
        )

        file_results = fileResult(
            f'Dynamic analysis report file for sample {sha1}',
            json.dumps(response_json, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE
        )

        return_results([results, file_results])


    def certificate_analytics_command():
        cert_analytics = CertificateAnalytics(
            host=TICLOUD_URL,
            username=USERNAME,
            password=PASSWORD
        )

        thumbprint = demisto.getArg("certificate_thumbprint")

        try:
            response = cert_analytics.get_certificate_analytics(certificate_thumbprints=thumbprint)
        except Exception as e:
            return_error(str(e))

        response_json = response.json()

        results = CommandResults(
            outputs_prefix='ReversingLabs',
            outputs={'certificate_analytics': response_json},
            readable_output="Full report is returned in a downloadable file"
        )

        file_results = fileResult(
            f'Certificate Analytics report file for thumbprint {thumbprint}',
            json.dumps(response_json, indent=4),
            file_type=EntryType.ENTRY_INFO_FILE
        )

        return_results([results, file_results])


    def main():
        command = demisto.command()

        if command == "test-module":
            test_module_command()

        elif command == "reversinglabs-titaniumcloud-file-reputation":
            file_reputation_command()

        elif command == "reversinglabs-titaniumcloud-av-scanners":
            av_scanners_command()

        elif command == "reversinglabs-titaniumcloud-file-analysis":
            file_analysis_command()

        elif command == "reversinglabs-titaniumcloud-rha1-functional-similarity":
            functional_similarity_command()

        elif command == "reversinglabs-titaniumcloud-rha1-analytics":
            rha1_analytics_command()

        elif command == "reversinglabs-titaniumcloud-uri-statistics":
            uri_statistics_command()

        elif command == "reversinglabs-titaniumcloud-uri-index":
            uri_index_command()

        elif command == "reversinglabs-titaniumcloud-advanced-search":
            advanced_search_command()

        elif command == "reversinglabs-titaniumcloud-expression-search":
            expression_search_command()

        elif command == "reversinglabs-titaniumcloud-file-download":
            file_download_command()

        elif command == "reversinglabs-titaniumcloud-file-upload":
            file_upload_command()

        elif command == "reversinglabs-titaniumcloud-url-report":
            url_report_command()

        elif command == "reversinglabs-titaniumcloud-analyze-url":
            analyze_url_command()

        elif command == "reversinglabs-titaniumcloud-submit-for-dynamic-analysis":
            detonate_sample_command()

        elif command == "reversinglabs-titaniumcloud-get-dynamic-analysis-results":
            dynamic_analysis_results_command()

        elif command == "reversinglabs-titaniumcloud-certificate-analytics":
            certificate_analytics_command()

        else:
            return_error(f"Command {command} does not exist")


    if __name__ in ("__main__", "__builtin__", "builtins"):
        main()

    register_module_line('ReversingLabs TitaniumCloud v2', 'end', __line__())
  subtype: python3
  type: python
system: true
