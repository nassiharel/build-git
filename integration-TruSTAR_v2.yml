category: Data Enrichment & Threat Intelligence
commonfields:
  id: TruSTAR v2
  version: -1
configuration:
- defaultvalue: https://api.trustar.co
  display: Server URL (e.g. https://api.trustar.co)
  name: server
  required: true
  type: 0
- defaultvalue: https://station.trustar.co
  display: Station URL (e.g. https://station.trustar.co)
  name: station
  required: false
  type: 0
- display: TruSTAR API Key
  name: key
  required: true
  type: 0
- display: TruSTAR API Secret
  name: secret
  required: true
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 5.0.0
    itemVersion: 2.1.6
    packID: TruSTAR
    packName: TruSTAR
    packPropagationLabels:
    - all
    propagationLabels: []
    toServerVersion: ""
description: TruSTAR is an Intelligence Management Platform that helps you operationalize
  data across tools and teams, helping you prioritize investigations and accelerate
  incident response.
detaileddescription: "### Partner Contributed Integration\n#### Integration Author:
  TruSTAR\nSupport and maintenance for this integration are provided by the author.
  Please use the following contact details:\n- **Email**: [support@trustar.co](mailto:support@trustar.co)\n-
  **URL**: [https://www.trustar.co](https://www.trustar.co)\n***\n## TruSTAR v2\n\nTo
  setup you TruSTAR integration, please input the following:\n\n- TruSTAR API Key
  \n\n- TruSTAR API Secret\n\nThese values can be taken from the API Settings on TruSTAR
  station\n\n---\n[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/tru-star-v2)"
display: TruSTAR v2 (Partner Contribution)
image: data:image/png;base64,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
name: TruSTAR v2
script:
  commands:
  - arguments:
    - description: The term to search for (e.g. covid-19)
      name: search_term
    - description: Comma-separated list of enclave ids; (i.e. <enclave1>,<enclave2>,<enclave3>).
        Only indicators found in reports from these enclaves will be returned (defaults
        to all of userâ€™s enclaves). Defaults is all enclaves the user has READ access
        to. You can get a list of your enclave IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - description: Start of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: from_time
    - description: End of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: to_time
    - description: comma-separated indicator types to filter by. e.g. "URL, IP"
      isArray: true
      name: indicator_types
    - description: Name (or list of names) of tag(s) to filter indicators by. (i.e.
        <tag1>,<tag2>,<tag3>). Only indicators containing ALL of these tags will be
        returned.
      isArray: true
      name: tags
    - description: Indicators containing ANY of these tags will be excluded from the
        results. Can be a single tag or a list of tags. i.e. <tag1>,<tag2>,<tag3>).
      isArray: true
      name: excluded_tags
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Searches for all indicators that contain the given search term.
    name: trustar-search-indicators
    outputs:
    - contextPath: TruSTAR.Indicators.indicatorType
      description: Indicator type
      type: string
    - contextPath: TruSTAR.Indicators.value
      description: Indicator value
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments: []
    description: Returns the list of all enclaves that the user has access to, as
      well as whether they can read, create, and update reports in that enclave.
    name: trustar-get-enclaves
    outputs:
    - contextPath: TruSTAR.Enclaves.id
      description: Enclave type
      type: string
    - contextPath: TruSTAR.Enclaves.name
      description: Enclave name
      type: string
    - contextPath: TruSTAR.Enclaves.type
      description: Enclave type
      type: string
    - contextPath: TruSTAR.Enclaves.create
      description: True if I have create permissions on enclave
      type: Bool
    - contextPath: TruSTAR.Enclaves.update
      description: True if I have update permissions on enclave
      type: Bool
    - contextPath: TruSTAR.Enclaves.read
      description: True if I have read permissions on enclave
      type: Bool
  - arguments:
    - default: true
      description: Comma separated indicator values. Values can be any of the following
        types; i.e. an IP address, email address, URL, MD5, SHA1, SHA256, Registry
        Key, Malware name, etc.
      isArray: true
      name: indicators
      required: true
    - description: Comma-separated list of enclave IDs; (i.e. <enclave1>,<enclave2>,<enclave3>).
        Only indicators found in reports from these enclaves will be returned (defaults
        to all of userâ€™s enclaves). Defaults is all enclaves the user has READ access
        to. You can get a list of your enclave IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Finds all reports that contain any of the given indicators and returns
      correlated indicators from those reports.
    name: trustar-related-indicators
    outputs:
    - contextPath: TruSTAR.Indicators.indicatorType
      description: Indicator type
      type: string
    - contextPath: TruSTAR.Indicators.value
      description: Indicator value
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments:
    - auto: PREDEFINED
      defaultValue: other
      description: The types of indicators to be returned. If other, then all indicator
        types except for CVE and MALWARE will be returned.
      name: indicator_type
      predefined:
      - CVE
      - MALWARE
      - other
    - defaultValue: "3"
      description: The number of days back to count correlations for.
      name: days_back
    description: Find indicators that are trending in the community.
    name: trustar-trending-indicators
    outputs:
    - contextPath: TruSTAR.Indicators.correlationCount
      description: Indicator correlation count
      type: Number
    - contextPath: TruSTAR.Indicators.indicatorType
      description: Indicator type
      type: string
    - contextPath: TruSTAR.Indicators.value
      description: Indicator value
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments:
    - default: true
      description: Comma separated indicator values. Values can be any of the following
        types; i.e. an IP address, email address, URL, MD5, SHA1, SHA256, Registry
        Key, Malware name, etc.
      isArray: true
      name: indicators
      required: true
    - description: CSV of enclave IDs to restrict to. (i.e. <enclave1>,<enclave2>,<enclave3>).
        By default, uses all of the userâ€™s enclaves. You can get a list of your enclave
        IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    description: Provide metadata associated with a list of indicators, including
      value, indicatorType, noteCount, sightings, lastSeen, enclaveIds, and tags.
      The metadata is determined based on the enclaves the user making the request
      has READ access to.
    name: trustar-indicators-metadata
    outputs:
    - contextPath: TruSTAR.IndicatorsMetadata.notes
      description: Indicator notes
      type: string
    - contextPath: TruSTAR.IndicatorsMetadata.indicatorType
      description: Indicator type
      type: string
    - contextPath: TruSTAR.IndicatorsMetadata.firstSeen
      description: Indicator first seen value
      type: Date
    - contextPath: TruSTAR.IndicatorsMetadata.correlationCount
      description: Indicator correlation count
      type: Number
    - contextPath: TruSTAR.IndicatorsMetadata.value
      description: Indicator value
      type: string
    - contextPath: TruSTAR.IndicatorsMetadata.lastSeen
      description: Indicator last seen value
      type: Date
    - contextPath: TruSTAR.IndicatorsMetadata.tags
      description: Indicator tags
      type: string
    - contextPath: TruSTAR.IndicatorsMetadata.enclaveIds
      description: Enclave IDs where indicator is present
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments:
    - default: true
      description: Comma separated indicator values. Values can be any of the following
        types; i.e. an IP address, email address, URL, MD5, SHA1, SHA256, Registry
        Key, Malware name, etc.
      isArray: true
      name: values
      required: true
    - description: CSV of enclaves to search for indicator summaries in. (i.e. <enclave1>,<enclave2>,<enclave3>).
        These should be enclaves containing data from sources on the TruSTAR Marketplace.
        You can get a list of your enclave IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Provides structured summaries about indicators, which are derived
      from intelligence sources on the TruSTAR Marketplace.
    name: trustar-indicator-summaries
    outputs:
    - contextPath: TruSTAR.IndicatorSummaries.severityLevel
      description: Indicator severity level
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.reportId
      description: Indicator report ID
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.value
      description: Indicator value
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.score.name
      description: Indicator score name
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.score.value
      description: Indicator score value
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.attributes
      description: Indicator attributes
      type: String
    - contextPath: TruSTAR.IndicatorSummaries.enclaveId
      description: Indicator enclave ID
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.type
      description: Indicator type
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.source.key
      description: Indicator source key
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.source.name
      description: Indicator source name
      type: string
    - contextPath: TruSTAR.IndicatorSummaries.updated
      description: Indicator last update value
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments:
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Gets a list of indicators that the userâ€™s company has added to allow
      list.
    name: trustar-get-whitelisted-indicators
    outputs:
    - contextPath: TruSTAR.WhitelistedIndicators.indicatorType
      description: File MD5
      type: string
    - contextPath: TruSTAR.WhitelistedIndicators.value
      description: File SHA1
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments:
    - description: Start of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: from_time
    - description: End of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: to_time
    - auto: PREDEFINED
      defaultValue: ENCLAVE
      description: Whether to search for reports in the community, or only in enclaves
      name: distribution_type
      predefined:
      - ENCLAVE
      - COMMUNITY
    - description: Comma separated list of enclave ids to search for reports in. (i.e.
        <enclave1>,<enclave2>,<enclave3>). Even if distributionType is COMMUNITY,
        these enclaves will still be searched as well. Default is All enclaves the
        user has READ access to. You can get a list of your enclave IDs executing
        the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - description: a list of names of tags to filter by; only reports containing ALL
        of these tags will be returned. i.e. <tag1>,<tag2>,<tag3>).
      isArray: true
      name: tags
    - description: reports containing ANY of these tags will be excluded from the
        results. Can be a single tag or a list of tags. i.e. <tag1>,<tag2>,<tag3>).
      isArray: true
      name: excluded_tags
    description: 'Returns incident reports matching the specified filters. All parameters
      are optional: if nothing is specified, the latest 25 reports accessible by the
      user will be returned (matching the view the user would have by logging into
      Station).'
    name: trustar-get-reports
    outputs:
    - contextPath: TruSTAR.Report.title
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
  - arguments:
    - description: the ID of the report to get the indicators from
      name: report_id
      required: true
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Return a list of indicators extracted from a report.
    name: trustar-get-indicators-for-report
    outputs:
    - contextPath: TruSTAR.Indicators.type
      description: Indicator type
      type: string
    - contextPath: TruSTAR.Indicators.value
      description: Indicator value
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  - arguments:
    - description: the ID of the report you want to move
      name: report_id
      required: true
    - description: the ID of the destination enclave
      name: dest-enclave-id
      required: true
    description: Move a report from one enclave to another.
    name: trustar-move-report
  - arguments:
    - description: the ID of the report you want to move
      name: report_id
      required: true
    - description: the ID of the destination enclave
      name: dest_enclave_id
      required: true
    description: Copies a report from one enclave to another.
    name: trustar-copy-report
  - arguments:
    - description: Title of the report
      name: title
      required: true
    - description: Text content of report
      name: report_body
      required: true
    - description: CSV of TruSTAR-generated enclave ids. (i.e. <enclave1>,<enclave2>,<enclave3>).
        Use the enclave ID, NOT the enclave name. Mandatory if the distribution type
        is ENCLAVE. You can get a list of your enclave IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - auto: PREDEFINED
      defaultValue: ENCLAVE
      description: Distribution type of the report
      name: distribution_type
      predefined:
      - COMMUNITY
      - ENCLAVE
    - description: URL for the external report that this originated from, if one exists.
        Limit 500 alphanumeric characters. Must be unique across all reports for a
        given company.
      name: external_url
    - description: ISO-8601 formatted incident time with timezone, e.g. 2016-09-22T11:38:35+00:00.
        Default is current time.
      name: time_began
    - auto: PREDEFINED
      defaultValue: "NO"
      description: YES OR NO. If redact is YES, all terms from user's company redaction
        library in TruSTAR will be applied before submitting. If NO, submits the report
        with body and title as written by the user.
      name: redact
      predefined:
      - "YES"
      - "NO"
    description: Submit a new incident report, and receive the ID it has been assigned
      in TruSTARâ€™s system.
    name: trustar-submit-report
    outputs:
    - contextPath: TruSTAR.Report.title
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
  - arguments:
    - description: Finds a report by its internal or external id.
      name: report_id
      required: true
    - auto: PREDEFINED
      defaultValue: internal
      description: Type of report ID
      name: id_type
      predefined:
      - internal
      - external
    description: Deletes a report as specified by given id (id can be TruSTAR report
      id or external id).
    name: trustar-delete-report
  - arguments:
    - description: Comma separated indicator values. Values can be any of the following
        types; i.e. an IP address, email address, URL, MD5, SHA1, SHA256, Registry
        Key, Malware name, etc.
      isArray: true
      name: indicators
      required: true
    - description: Comma-separated list of enclave ids; (i.e. <enclave1>,<enclave2>,<enclave3>).
        Only indicators found in reports from these enclaves will be returned (defaults
        to all of userâ€™s enclaves). Defaults is all enclaves the user has READ access
        to. You can get a list of your enclave IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave-ids
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    - auto: PREDEFINED
      defaultValue: ENCLAVE
      description: Distribution type of the report
      name: distribution_type
      predefined:
      - COMMUNITY
      - ENCLAVE
    description: Returns a list of all reports that contain any of the provided indicator
      values.
    name: trustar-correlated-reports
  - arguments:
    - description: Finds a report by its internal or external id.
      name: report_id
      required: true
    - auto: PREDEFINED
      defaultValue: internal
      description: Type of report ID
      name: id_type
      predefined:
      - internal
      - external
    description: Finds a report by its ID and returns the report details.
    name: trustar-report-details
    outputs:
    - contextPath: TruSTAR.Report.title
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
  - arguments:
    - description: TruSTAR report id or external tracking id.
      name: report_id
      required: true
    - description: Title of the report
      name: title
    - description: Text content of report
      name: report-body
    - description: CSV of TruSTAR-generated enclave ids. (i.e. <enclave1>,<enclave2>,<enclave3>).
        Use the enclave ID, NOT the enclave name. Mandatory if the distribution type
        is ENCLAVE. You can get a list of your enclave IDs executing the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - description: URL for the external report that this originated from, if one exists.
        Limit 500 alphanumeric characters. Must be unique across all reports for a
        given company.
      name: external_url
    - auto: PREDEFINED
      defaultValue: ENCLAVE
      description: Distribution type of the report
      name: distribution_type
      predefined:
      - COMMUNITY
      - ENCLAVE
    - description: ISO-8601 formatted incident time with timezone, e.g. 2016-09-22T11:38:35+00:00.
        Default is current time.
      name: time_began
    description: Update the report with the specified ID. Either the internal TruSTAR
      report ID or an external tracking ID can be used. Only the fields passed will
      be updated. All others will be left unchanged.
    name: trustar-update-report
    outputs:
    - contextPath: TruSTAR.Report.title
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
  - arguments:
    - default: true
      description: The term to search for (e.g. covid-19) If empty, no search term
        will be applied. Otherwise, must be at least 3 characters.
      name: search_term
    - description: Comma-separated list of enclave ids (i.e. <enclave1>,<enclave2>,<enclave3>).
        Only indicators found in reports from these enclaves will be returned (defaults
        to all of userâ€™s enclaves). You can get a list of your enclave IDs executing
        the command '!trustar-get-enclaves'
      isArray: true
      name: enclave_ids
    - description: Start of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: from_time
    - description: End of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: to_time
    - description: Name (or list of names) of tag(s) to filter indicators by. i.e.
        <tag1>,<tag2>,<tag3>). Only indicators containing ALL of these tags will be
        returned.
      isArray: true
      name: tags
    - description: Indicators containing ANY of these tags will be excluded from the
        results. Can be a single tag or a list of tags. i.e. <tag1>,<tag2>,<tag3>).
      isArray: true
      name: excluded_tags
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Searches for all reports that contain the given search term.
    name: trustar-search-reports
    outputs:
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
    - contextPath: TruSTAR.Report.title
      description: Report Title
      type: string
  - arguments:
    - default: true
      description: CSV of indicators to add to allow list, i.e. evil.com,101.43.52.224
      isArray: true
      name: indicators
      required: true
    description: Add to allow list a list of indicator values for the userâ€™s company.
    name: trustar-add-to-whitelist
  - arguments:
    - description: The value of the indicator to delete.
      name: indicator
      required: true
    - auto: PREDEFINED
      description: The type of the indicator to delete.
      name: indicator_type
      predefined:
      - URL
      - IP
      - SHA256
      - SHA1
      - MD5
      - SOFTWARE
      - EMAIL_ADDRESS
      - BITCOIN_ADDRESS
      - CIDR_BLOCK
      - CVE
      - REGISTRY_KEY
      required: true
    description: Delete an indicator from the userâ€™s company allow list.
    name: trustar-remove-from-whitelist
  - arguments:
    - defaultValue: -1,0,1,2,3
      description: List of email submissions scores to restrict the query. Possible
        values are -1, 0, 1, 2, 3. (i.e. -1,0,2)
      isArray: true
      name: priority_event_score
    - description: Start of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: from_time
    - description: End of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: to_time
    - auto: PREDEFINED
      defaultValue: UNRESOLVED
      description: A list of triage statuses for submissions (UNRESOLVED,CONFIRMED,IGNORED);
        only email submissions marked with at least one of these statuses will be
        returned
      isArray: true
      name: status
      predefined:
      - UNRESOLVED
      - CONFIRMED
      - IGNORED
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Fetches all phishing submissions that fit the given criteria
    name: trustar-get-phishing-submissions
    outputs:
    - contextPath: TruSTAR.PhishingSubmission.submissionId
      description: The submission ID
      type: string
    - contextPath: TruSTAR.PhishingSubmission.title
      description: Submission title
      type: string
    - contextPath: TruSTAR.PhishingSubmission.normalizedTriageScore
      description: Submission triage score
      type: number
    - contextPath: TruSTAR.PhishingSubmission.context.indicatorType
      description: Indicator type
      type: string
    - contextPath: TruSTAR.PhishingSubmission.context.sourceKey
      description: Indicator source
      type: string
    - contextPath: TruSTAR.PhishingSubmission.context.normalizedSourceScore
      description: Indicator score
      type: number
    - contextPath: TruSTAR.PhishingSubmission.context.originalIndicatorScore.name
      description: Original Indicator score name
      type: string
    - contextPath: TruSTAR.PhishingSubmission.context.originalIndicatorScore.value
      description: Original Indicator score value
      type: string
  - arguments:
    - description: ID of the email submission
      name: submission_id
      required: true
    - auto: PREDEFINED
      description: Submission status
      name: status
      predefined:
      - CONFIRMED
      - IGNORED
      required: true
    description: Marks a phishing email submission with one of the phishing namespace
      tags
    name: trustar-set-triage-status
  - arguments:
    - defaultValue: -1,0,1,2,3
      description: List of Intel scores to restrict the query. Possible values are
        -1, 0, 1, 2, 3. (i.e. 0,2,3),
      isArray: true
      name: normalized_indicator_score
    - defaultValue: -1,0,1,2,3
      description: List of email submissions scores to restrict the query. Possible
        values are -1, 0, 1, 2, 3. (i.e. 0,2,3),
      isArray: true
      name: priority_event_score
    - description: Start of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: from_time
    - description: End of time window (format can be absolute like YYYY-MM-DD HH:MM:SS,
        i.e. 2018-01-01 10:30:00; OR relative, i.e. '10 minutes ago', '5 days ago',
        etc). Based on updated time, and not created time. Default is 1 day ago.
      name: to_time
    - auto: PREDEFINED
      defaultValue: UNRESOLVED,CONFIRMED,IGNORED
      description: A list of triage statuses for submissions; only email submissions
        marked with at least one of these statuses will be returned. Options are 'UNRESOLVED',
        'CONFIRMED', 'IGNORED'
      isArray: true
      name: status
      predefined:
      - UNRESOLVED
      - CONFIRMED
      - IGNORED
    - defaultValue: "25"
      description: Limit of results to return. Max value possible is 1000.
      name: limit
    description: Get phishing indicators that match the given criteria.
    name: trustar-get-phishing-indicators
    outputs:
    - contextPath: TruSTAR.PhishingIndicator.indicatorType
      description: Indicator Type
      type: string
    - contextPath: TruSTAR.PhishingIndicator.normalizedIndicatorScore
      description: Indicator normalized score
      type: number
    - contextPath: TruSTAR.PhishingIndicator.originalIndicatorScore.name
      description: Indicator original score name
      type: string
    - contextPath: TruSTAR.PhishingIndicator.originalIndicatorScore.value
      description: Indicator original score value
      type: string
    - contextPath: TruSTAR.PhishingIndicator.sourceKey
      description: Indicator source key
      type: string
    - contextPath: TruSTAR.PhishingIndicator.value
      description: Indicator value
      type: string
    - contextPath: File.Name
      description: The full file name (including file extension).
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA1 hash of the file.
      type: String
    - contextPath: IP.Address
      description: IP address
      type: String
    - contextPath: URL.Data
      description: The URL
      type: String
    - contextPath: CVE.ID
      description: 'The ID of the CVE, for example: CVE-2015-1653'
      type: String
    - contextPath: Account.Email.Address
      description: The email address of the account.
      type: String
    - contextPath: RegistryKey.Path
      description: The path to the registry key
      type: String
    - contextPath: Domain.Name
      description: 'The domain name, for example: "google.com".'
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
      type: string
    - contextPath: DBotScore.Score
      description: The actual score.
      type: number
  dockerimage: demisto/trustar:20.2.0.24037
  runonce: false
  script: |
    register_module_line('TruSTAR v2', 'start', __line__())
    from typing import Tuple




    ''' IMPORTS '''

    import dateparser
    import requests
    import trustar
    from trustar.models.indicator import Indicator
    from trustar.models.report import Report

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    handle_proxy()


    class Utils(object):
        """
        Class with some utility methods.
        """
        @staticmethod
        def normalize_time(timestamp):
            ''' Converts unix epoch time to GMT '''
            if isinstance(timestamp, str):
                return timestamp
            return time.strftime('%Y-%m-%d %H:%M:%S', time.gmtime(timestamp / 1000.0))

        @staticmethod
        def date_to_unix(timestamp):
            d = dateparser.parse(timestamp)
            assert d is not None, f'could not parse {timestamp}'
            return int(d.strftime("%s")) * 1000


    class ContextManager(object):
        """
        Manages where to put the data depending if the data to output is an indicator or not.

        If data is an indicator, the data is returned on 3 contexts:
        - DBotScore context: Contains the value of the IOC, the vendor (TruSTAR) and a score of 0.
        - Standard context: Groups all IOCs by types and returns the value of each one.
        - TruSTAR context: Contains all the information fetched from TruSTAR corresponding to each indicator.
        Data is also returned on the TruSTAR context for phishing submissions and reports.
        """

        INDICATOR_TYPES = {
            'URL': Common.URL,
            'IP': Common.IP,
            'DOMAIN': Common.Domain,
            'CVE': Common.CVE
        }

        DBOTSCORE_TYPES = {
            'URL': DBotScoreType.URL,
            'IP': DBotScoreType.IP,
            'DOMAIN': DBotScoreType.DOMAIN,
            'CVE': DBotScoreType.CVE,
            'SOFTWARE': DBotScoreType.FILE,
            'SHA256': DBotScoreType.FILE,
            'SHA1': DBotScoreType.FILE,
            'MD5': DBotScoreType.FILE,
        }

        FILE_TYPES = ['SOFTWARE', 'SHA256', 'SHA1', 'MD5']

        def _get_dbot_score(self, ts_indicator):
            """ Returns a DBotScore object with score as None """
            indicator_type = ts_indicator.get('indicatorType')
            dbot_score = Common.DBotScore(
                indicator=ts_indicator.get('value'),
                indicator_type=self.DBOTSCORE_TYPES.get(indicator_type),
                integration_name='TruSTAR',
                score=Common.DBotScore.NONE
            )
            return dbot_score

        def _get_xsoar_file_indicator(self, ts_indicator, dbot_score):
            """
            Returns a Common.File object. Handles logic to create the object with
            the corresponding type (SHA1, SHA256, MD5 or Name if software).
            """

            key = ts_indicator.get('indicatorType')
            key = "name" if key == "SOFTWARE" else key
            value = ts_indicator.get('value')
            args = {
                key.lower(): value,
                'dbot_score': dbot_score
            }
            xsoar_file_indicator = Common.File(**{k: v for k, v in args.items() if k})
            return xsoar_file_indicator

        def _get_xsoar_indicator_and_readable_output(self, ts_indicator) -> Tuple[Common.Indicator, str]:
            """
            Returns a XSoar Indicator with DBotScore embedded and their human readable. Indicators can be:
            - Common.File
            - Common.IP
            - Common.URL
            - Common.CVE
            """

            indicator_type = ts_indicator.get('indicatorType')
            if indicator_type == "CVE":
                return (Common.CVE(ts_indicator.get('value'), None, None, None, None),
                        f'Fetched CVE {ts_indicator.get("value")} details')

            dbot_score = self._get_dbot_score(ts_indicator)
            if indicator_type in self.FILE_TYPES:
                return (self._get_xsoar_file_indicator(ts_indicator, dbot_score),
                        f'Fetched File {ts_indicator.get("value")} details')

            XSOARIndicator = self.INDICATOR_TYPES.get(indicator_type)
            xsoar_indicator = XSOARIndicator(
                ts_indicator.get('value'),
                dbot_score=dbot_score
            ) if XSOARIndicator is not None else None
            return xsoar_indicator, f'Fetched {indicator_type} {ts_indicator.get("value")} details'

        def _remove_priority_level(self, indicator_dict):
            """  Removes priority level from indicator. It is a deprecated field """
            if indicator_dict.get('priorityLevel'):
                indicator_dict.pop('priorityLevel')

            return indicator_dict

        def get_context(self, indicators, context='Indicator'):
            """
            Handles logic to return an entry context with xsoar and non xsoar indicators
            on their corresponding contexts.
            """
            context_results: List[dict] = []
            indicators = [self.convert_indicator_timestamps(d) for d in indicators]
            indicators = [self._remove_priority_level(d) for d in indicators]
            xsoar_indicators = [
                self._get_xsoar_indicator_and_readable_output(d)
                for d in indicators
                if d.get('indicatorType') not in {'EMAIL_ADDRESS', 'REGISTRY_KEY', 'MALWARE', 'CIDR_BLOCK'}
            ]
            for xsoar_ioc, hr in xsoar_indicators:
                context_results.append(CommandResults(
                    indicator=xsoar_ioc,
                    readable_output=hr
                ).to_context())

            standard_context = self.get_non_xsoar_standard_context(indicators)
            results = CommandResults(
                outputs_prefix=f'TruSTAR.{context}',
                outputs_key_field='value',
                outputs=indicators,
            )
            context = results.to_context()
            context['EntryContext'].update(standard_context)

            # insert the TruStar result as the first item in results
            context_results.insert(0, context)
            return context_results

        def convert_indicator_timestamps(self, indicator):
            """ Converts indicator timestamp fields. """
            d = {
                t: Utils.normalize_time(indicator.get(t))
                for t in ['firstSeen', 'lastSeen']
                if t in indicator.keys()
            }
            indicator.update(d)
            return indicator

        def get_indicators_context(self, indicators, context='Indicators'):
            ts_indicator_dicts = [
                i.to_dict(remove_nones=True)
                for i in indicators
            ]

            return self.get_context(ts_indicator_dicts, context)

        def get_indicator_summaries_context(self, indicators, context='Indicators'):
            ts_indicator_dicts = [
                i.to_dict(remove_nones=True)
                for i in indicators
            ]

            for d in ts_indicator_dicts:
                d['indicatorType'] = d.pop('type')  # Adding IndicatorType field

            return self.get_context(ts_indicator_dicts, context)

        def get_non_xsoar_standard_context(self, indicator_dicts):
            """
            Returns a standard context for those indicator types that can not be automated
            with one of the 'Common' classes. Depending on the type of indicator,
            the data is put on the corresponding context.
            """
            emails = [
                {'Address': i.get('value')}
                for i in indicator_dicts
                if i.get('indicatorType') == "EMAIL_ADDRESS"
            ]

            registries = [
                {'Path': i.get('value')}
                for i in indicator_dicts
                if i.get('indicatorType') == "REGISTRY_KEY"
            ]
            standard_ec = {}
            if emails:
                standard_ec['Account.Email(val.Address && val.Address === obj.Address)'] = emails
            if registries:
                standard_ec['RegistryKey(val.Path && val.Path === obj.Path)'] = registries

            return standard_ec

        def translate_triage_submission(self, submissions):
            """ Returns Entry Contex for Phishing Submissions """
            submission_dicts = [s.to_dict(remove_nones=True) for s in submissions]
            ec = {'TruSTAR.PhishingSubmission(val.submissionId == obj.submissionId)': submission_dicts}
            return submission_dicts, ec

        def get_enclaves_ec(self, enclaves):

            context = [enclave.to_dict(remove_nones=True) for enclave in enclaves]
            ec = {
                'TruSTAR.Enclave(val.id && val.id === obj.id)': context
            }
            return context, ec

        def _get_report_context_fields(self, report):
            context_fields = ["id", "title", "reportBody"]
            fields = {k: v for k, v in report.items() if k in context_fields}
            return fields

        def get_reports_ec(self, reports):
            """ Returns entry context for Reports """
            context = [self._get_report_context_fields(report) for report in reports]
            ec = {
                'TruSTAR.Report(val.id && val.id === obj.id)': context
            }
            return ec

    # ## CLIENT ###


    class TrustarClient:
        """
        Class wrapper of TruSTAR SDK.

        Interpretates a command and retrieves the correspondding data
        from TruSTAR to be shown on the war room and put on the corresponding
        context.
        """

        LIST_ARGS = [
            "indicators",
            "indicator_types",
            "values",
            "enclave_ids",
            "priority_event_score",
            "normalized_indicator_score",
            "status",
            "tags",
            "exclueded_tags"
        ]

        def __init__(self, config, station=''):
            self.client = trustar.TruStar(config=config)
            self.command_dict = self._build_command_dict()
            self.context_manager = ContextManager()
            self.station = station

        def _build_command_dict(self):
            command_dict = {
                'test-module': self.test_module,
                'trustar-get-reports': self.get_reports,
                'trustar-get-enclaves': self.get_enclaves,
                'trustar-related-indicators': self.get_related_indicators,
                'trustar-indicators-metadata': self.get_indicators_metadata,
                'trustar-indicator-summaries': self.get_indicator_summaries,
                'trustar-get-whitelisted-indicators': self.get_whitelist,
                'trustar-move-report': self.move_report,
                'trustar-trending-indicators': self.get_trending_indicators,
                'trustar-get-indicators-for-report': self.get_indicators_for_report,
                'trustar-search-indicators': self.search_indicators,
                'trustar-submit-report': self.submit_report,
                'trustar-delete-report': self.delete_report,
                'trustar-correlated-reports': self.get_correlated_reports,
                'trustar-add-to-whitelist': self.add_to_whitelist,
                'trustar-remove-from-whitelist': self.remove_from_whitelist,
                'trustar-report-details': self.get_report_details,
                'trustar-update-report': self.update_report,
                'trustar-search-reports': self.search_reports,
                'trustar-get-phishing-indicators': self.get_all_phishing_indicators,
                'trustar-get-phishing-submissions': self.get_phishing_submissions,
                'trustar-set-triage-status': self.set_triage_status,
                'trustar-copy-report': self.copy_report
            }
            return command_dict

        def get_entry(self, title='', contents=None, ec=None):
            """
            Returns Context dictionary
            """
            entry = {
                'Type': EntryType.NOTE,
                'Contents': contents,
                'ContentsFormat': EntryFormat.JSON,
                'ReadableContentsFormat': EntryFormat.MARKDOWN,
                'HumanReadable': tableToMarkdown(title, contents),
            }
            if ec:
                entry['EntryContext'] = ec

            return entry

        def get_report_timestamps(self, report):
            """ Given a report dictionary, it returns the timestamp fields
            on a dictionary.
            """
            d = {
                t: Utils.normalize_time(report[t])
                for t in ['updated', 'created', 'timeBegan']
                if report.get(t)
            }
            return d

        def get_report_deep_link(self, report_id):
            """ Returns report link on TruSTAR self.station. """
            return f'{self.station}/constellation/reports/{report_id}'

        def test_module(self):
            """Tests connectivity with TruSTAR"""
            try:
                self.client.ping()
                return "ok"
            except requests.exceptions.HTTPError:
                return ("Invalid Credentials. Please check your API Key and Secret"
                        "are correct on TruSTAR Station. Settings > API")

        def search_indicators(self,
                              search_term=None,
                              enclave_ids=None,
                              from_time=None,
                              to_time=None,
                              indicator_types=None,
                              tags=None,
                              excluded_tags=None,
                              limit=None):
            """
            Searches for all indicators that contain the given search term.

            :param search_term: Term to be searched.
            :param enclave_ids: list of enclaves to restrict the search to.
            "param limit: Max number of entries to be returned.

            :return: Entry context with found indicators.
            """
            """
            Searches for all indicators that contain the given search term.

            :param search_term: Term to be searched.
            :param enclave_ids: list of enclaves to restrict the search to.
            "param limit: Max number of entries to be returned.

            :return: Entry context with found indicators.
            """
            from_time = Utils.date_to_unix(from_time) if from_time else from_time
            to_time = Utils.date_to_unix(to_time) if to_time else to_time
            try:
                response = self.client.search_indicators_page(
                    search_term=search_term,
                    enclave_ids=enclave_ids,
                    from_time=from_time,
                    to_time=to_time,
                    tags=tags,
                    indicator_types=indicator_types,
                    excluded_tags=excluded_tags,
                    page_number=0,
                    page_size=limit,
                )

                if not response:
                    return 'No indicators were found.'

            except requests.exceptions.HTTPError as err:
                if err.response.status_code == 400:
                    return 'No indicators were found.'

                raise(err)

            results = self.context_manager.get_indicators_context(response)
            return results

        def get_reports(self,
                        from_time=None,
                        to_time=None,
                        enclave_ids=None,
                        distribution_type=None,
                        tags=None,
                        excluded_tags=None):
            """
            Returns incident reports matching the specified filters.

            :param from_time: Start of polling window.
            :param to_time: End of polling window.
            :param enclave_ids: List of user enclaves to restrict the query.
            :param distribution_type: Whether to search for reports in the community, or only
            in enclaves.
            :param tags: a list of names of tags to filter by.
            :param excluded_tags: reports containing ANY of these tags will be excluded from the
            results.

            :return: Entry context with found reports.
            """
            is_enclave = (distribution_type == 'ENCLAVE')
            from_time = Utils.date_to_unix(from_time) if from_time else from_time
            to_time = Utils.date_to_unix(to_time) if to_time else to_time
            response = self.client.get_reports_page(
                is_enclave,
                enclave_ids,
                tags,
                excluded_tags,
                from_time,
                to_time
            )

            if not response:
                return 'No reports were found.'

            reports = []
            for report in response.items:
                current_report = report.to_dict(remove_nones=True)
                current_report['reportDeepLink'] = self.get_report_deep_link(current_report.get("id"))
                current_report.update(self.get_report_timestamps(current_report))
                reports.append(current_report)

            ec = self.context_manager.get_reports_ec(reports)
            title = 'TruSTAR reports'
            entry = self.get_entry(title, reports, ec)
            return entry

        def submit_report(self,
                          title=None,
                          report_body=None,
                          enclave_ids=None,
                          external_url=None,
                          time_began=None,
                          distribution_type="ENCLAVE",
                          redact="NO"):
            """
            Submits a new report to TruSTAR station.

            :param title: Title of the report.
            :param report_body: Body of the report.
            :param enclave_ids: Enclave IDs where to submit the report.
            :param external_url: External URL of the report.
            :param time_began: Incident time. Defaults to current time if not given.
            :param distribution_type: Whether the report will be in the community, or only
            in enclaves
            :param redact: Wether to redact a report before submitting or not.

            :return: Entry context with the submitted report.
            """
            if distribution_type == 'ENCLAVE' and enclave_ids is None:
                raise Exception('Distribution type is ENCLAVE, but no enclave ID was given.')

            if redact == "YES":
                response = self.client.redact_report(
                    title=title,
                    report_body=report_body
                )

                title = response.title
                report_body = response.body

            ts_report = trustar.models.Report(
                title=title,
                body=report_body,
                enclave_ids=enclave_ids,
                is_enclave=(distribution_type == 'ENCLAVE'),
                time_began=time_began,
                external_url=external_url
            )

            response = self.client.submit_report(ts_report)
            report = ts_report.to_dict(remove_nones=True)
            report['reportDeepLink'] = self.get_report_deep_link(response.id)
            report['id'] = response.id
            ec = self.context_manager.get_reports_ec([report])
            title = 'TruSTAR report was successfully created'
            entry = self.get_entry(title, report, ec)
            return entry

        def delete_report(self, report_id=None, id_type=None):
            """
            Deletes report from TruStar.

            :param report_id: ID of the report to be deleted.
            :param id_type: Report id type. External or internal.

            :return: Success Message.
            """
            self.client.delete_report(report_id, id_type)
            return f'Report {report_id} was successfully deleted'

        def get_correlated_reports(self,
                                   indicators=None,
                                   enclave_ids=None,
                                   distribution_type=None,
                                   limit=None):
            """
            Returns a list of all reports that contain any of the provided
            indicator values.

            :param indicators: indicators list to perform the query.
            :param enclave_ids: enclaves list to restrict the query.
            :param distribution_type: Distribution type of the report.
            :param limit: Maximum value of report to be returned.

            :return: Entry context with found reports.
            """
            response = self.client.get_correlated_reports_page(
                indicators,
                enclave_ids,
                is_enclave=(distribution_type == "ENCLAVE"),
                page_number=0,
                page_size=limit
            )

            if not response:
                return 'No reports were found.'

            correlated_reports = []
            for report in response:
                current_report = report.to_dict(remove_nones=True)
                current_report.update(self.get_report_timestamps(current_report))
                correlated_reports.append(current_report)

            title = 'TruSTAR correlated reports'
            entry = self.get_entry(title, correlated_reports)
            return entry

        def get_report_details(self, report_id=None, id_type=None):
            """
            Finds a report by its ID and returns the report details.

            :param report_id: Report ID.
            :param id_type: Type of report ID. External or internal.

            :return: Entry context with Report queried.
            """
            response = self.client.get_report_details(report_id, id_type)
            if not response:
                return f"No details were found for report ID {report_id}"

            current_report_dict = response.to_dict(remove_nones=True)
            id = current_report_dict.get("id")
            current_report_dict.update(self.get_report_timestamps(current_report_dict))
            current_report_dict['reportDeepLink'] = self.get_report_deep_link(id)

            ec = self.context_manager.get_reports_ec([current_report_dict])

            title = f'TruSTAR report ID {report_id} details'
            entry = self.get_entry(title, current_report_dict, ec)
            return entry

        def update_report(self, **kwargs):
            """
            Update the report with the specified ID. Either the internal TruSTAR
            report ID or an external tracking ID can be used. Only the fields passed will
            be updated. All other fiels will remain unchanged.

            :return: Entry Context with updated report.
            """
            report_id = kwargs.pop('report_id')
            ts_report = self.client.get_report_details(report_id).to_dict()

            if kwargs.get('distribution_type'):
                kwargs["distributionType"] = kwargs.pop('distribution_type')

            if kwargs.get('report_body'):
                kwargs["reportBody"] = kwargs.pop('report_body')

            if kwargs.get('enclave_ids'):
                kwargs["enclaveIds"] = kwargs.pop('enclave_ids')

            if kwargs.get('external_url'):
                kwargs["externalUrl"] = kwargs.pop('external_url')

            if kwargs.get('time_began'):
                kwargs["timeBegan"] = kwargs.pop('time_began')

            ts_report.update(kwargs)
            self.client.update_report(Report.from_dict(ts_report))

            ts_report.update(self.get_report_timestamps(ts_report))
            ts_report['reportDeepLink'] = self.get_report_deep_link(report_id)
            ec = self.context_manager.get_reports_ec([ts_report])

            title = 'TruSTAR report was successfully updated'
            entry = self.get_entry(title, ts_report, ec)
            return entry

        def get_enclaves(self):
            """
            Returns the list of all enclaves that the user has access to, as
            well as whether they can read, create, and update reports in that enclave.

            :return: Entry context with list of enclaves
            """
            response = self.client.get_user_enclaves()
            enclaves, ec = self.context_manager.get_enclaves_ec(response)

            if not response:
                return "No enclaves were found."

            title = 'TruSTAR Enclaves'
            entry = self.get_entry(title, enclaves, ec)
            return entry

        def get_related_indicators(self, indicators=None, enclave_ids=None, limit=None):
            """
            Finds all reports that contain any of the given indicators
            and returns correlated indicators from those reports.

            :param indicators: list of indicator values.
            :param enclave_ids: list of enclaves to filter found reports.
            :param limit: Max num of related indicators to return.

            :return: Entry Context with related indicators.
            """
            related_indicator_response = self.client.get_related_indicators_page(
                indicators=indicators,
                enclave_ids=enclave_ids,
                page_size=limit,
                page_number=0
            )

            if not related_indicator_response:
                return f'No indicators related to {indicators} were found.'

            results = self.context_manager.get_indicators_context(related_indicator_response.items)
            return results

        def get_trending_indicators(self, indicator_type=None, days_back=None):
            """
            Find indicators that are trending in the community.

            :param indicator_type: Types of indicators to be returned. If is equal to 'other',
            then all indicator types except for CVE and MALWARE will be returned.
            :param days_back: The number of days back to count correlations for.

            """
            indicator_type = None if indicator_type == 'other' else indicator_type
            response = self.client.get_community_trends(indicator_type, days_back)

            if not response:
                return 'No trending indicators were found.'

            results = self.context_manager.get_indicators_context(response)
            return results

        def search_reports(self,
                           search_term=None,
                           enclave_ids=None,
                           from_time=None,
                           to_time=None,
                           tags=None,
                           excluded_tags=None,
                           limit=None):
            """
            Searches for all reports that contain the given search term.

            :param search_term: term to search for within the reports.
            :param enclave_ids: list of enclaves to restrict te search to.

            :return: Entry Context with Found reports.
            """
            from_time = Utils.date_to_unix(from_time) if from_time else from_time
            to_time = Utils.date_to_unix(to_time) if to_time else to_time
            response = self.client.search_reports_page(
                search_term=search_term,
                enclave_ids=enclave_ids,
                from_time=from_time,
                to_time=to_time,
                tags=tags,
                excluded_tags=excluded_tags,
                page_number=0,
                page_size=limit
            )
            if not response:
                return "No reports were found"

            reports = []
            for report in response:
                current_report = report.to_dict(remove_nones=True)
                current_report.update(self.get_report_timestamps(current_report))
                reports.append(current_report)

            ec = self.context_manager.get_reports_ec(reports)

            title = f'TruSTAR reports that contain the term {search_term}'
            entry = self.get_entry(title, reports, ec)
            return entry

        def add_to_whitelist(self, indicators=None):
            """
            Adds a list of indicators to the Company's whitelist.

            :param indicators: list of indicators to be whitelisted.

            :return: Message indicating if the request was successful or not.
            """
            response = self.client.add_terms_to_whitelist(indicators)
            if not response:
                return 'Indicator could not be added to the whitelist.'

            return f'{indicators} added to the whitelist successfully'

        def remove_from_whitelist(self, indicator=None, indicator_type=None):
            """
            Deletes an indicator from the Company's whitelist.

            :param indicator: Indicator to be deleted.
            :param indicator_type: type of the indicator to be deleted.

            :return: Message with the result of the request.
            """
            ts_indicator = Indicator(
                value=indicator,
                type=indicator_type
            )
            try:
                self.client.delete_indicator_from_whitelist(ts_indicator)
                return f'{indicator} removed from the whitelist successfully'
            except Exception:
                return 'Indicator could not be removed from the whitelist.'

        def get_indicators_metadata(self, indicators=None, enclave_ids=None):
            """
            Provide metadata associated with a list of indicators. The metadata is determined based on the
            enclaves the user making the request has READ access to.

            :param indicators: indicators list to search the corresponding metadata.
            :param enclave_ids: list of enclave IDs to restrict to. By default, uses all of the userâ€™s enclaves.

            :return: Entry context with indicators metadata.
            """

            ts_indicators = [Indicator(value=i) for i in indicators]
            response = self.client.get_indicators_metadata(ts_indicators, enclave_ids)

            if not response:
                return 'No indicators metadata were found.'

            results = self.context_manager.get_indicators_context(response, "IndicatorsMetadata")
            return results

        def get_indicator_summaries(self, values=None, enclave_ids=None, limit=None):
            """
            Provides structured summaries about indicators, which are derived from
            intelligence sources on the TruSTAR Marketplace.

            :param values: list of indicator values to search on TruSTAR.
            :param enclave_ids: list of enclave_ids to restrict the query.
            :param limit: Maximum value of entries to return.

            :return: Entry Context with indicator summaries.
            """
            response = self.client.get_indicator_summaries_page(
                values,
                enclave_ids=enclave_ids,
                page_number=0,
                page_size=limit
            )

            if not response:
                return 'No indicator summaries were found.'

            results = self.context_manager.get_indicator_summaries_context(response.items, "IndicatorSummaries")
            return results

        def move_report(self, report_id=None, dest_enclave_id=None):
            """
            Moves report from one user enclave to another.

            :param report_id: Report ID.
            :dest_enclave_id: Enclave ID where the report will be moved.

            :return: Success Message.
            """
            response = self.client.move_report(report_id=report_id, dest_enclave_id=dest_enclave_id)
            return f"{response} has been moved to enclave id: {dest_enclave_id}"

        def copy_report(self, report_id=None, dest_enclave_id=None):
            """
            Copies report from one user enclave to another.

            :param report_id: Report ID.
            :dest_enclave_id: Enclave ID where the report will be moved.

            :return: Success Message.
            """

            response = self.client.copy_report(src_report_id=report_id, dest_enclave_id=dest_enclave_id)
            return f"{report_id} has been copied to enclave id: {dest_enclave_id} with id: {response}"

        def get_whitelist(self, limit=None):
            """
            Gets a list of indicators that the userâ€™s company has whitelisted.

            :param limit: Maximum number of whitelisted indicators to return.
            :return: Entry context with whitelisted indicators.
            """

            response = self.client.get_whitelist_page(page_number=0, page_size=limit)
            if not response:
                return 'No Whitelist was found.'

            results = self.context_manager.get_indicators_context(response.items, 'WhitelistedIndicators')
            return results

        def get_indicators_for_report(self, report_id=None, limit=None):
            """
            Return a list of indicators extracted from a report.

            :param report_id: Report ID to extract indicators from.
            :param limit: Max number of indicators to return.

            :return: Entry context with extracted indicators.
            """

            response = self.client.get_indicators_for_report_page(
                report_id=report_id,
                page_number=0,
                page_size=limit
            )

            if not response:
                return f'No Indicators were found in report {report_id}.'

            results = self.context_manager.get_indicators_context(response.items)
            return results

        def get_all_phishing_indicators(self,
                                        priority_event_score=None,
                                        normalized_indicator_score=None,
                                        from_time=None,
                                        to_time=None,
                                        status=None,
                                        limit=None):
            """
            Get phishing indicators that match the given criteria.

            :param priority_event_score: A list with the scores to restrict the search to.
            :param normalized_indicator_score: A list with the scores to restrict the search to.
            :param from_time: Start of the polling window.
            :param to_time: End of the polling window.
            :param status: Status of the phishing indicatror.
            :param limit: Limit of results to return. Default is 25.

            :return: Entry Context with Phishing Indicators found.
            """
            args = {'priority_event_score': priority_event_score,
                    'normalized_indicator_score': normalized_indicator_score,
                    'status': status,
                    'page_size': limit,
                    'from_time': Utils.date_to_unix(from_time) if from_time else None,
                    'to_time': Utils.date_to_unix(to_time) if to_time else None}
            response = self.client.get_phishing_indicators_page(**args)  # pylint: disable=E1123
            if not response:
                return 'No phishing indicators were found.'

            results = self.context_manager.get_indicators_context(response.items, 'PhishingIndicator')
            return results

        def get_phishing_submissions(self,
                                     priority_event_score=None,
                                     from_time=None,
                                     to_time=None,
                                     status=None,
                                     limit=None):
            """
            Fetches all phishing submissions that fit the given criteria.

            :param priority_event_score: List of scores to restrict the search to.
            :param from_time: Start of polling window.
            :param to_time: End of polling window.
            :param status: List of phishing submission status to restrict the search to.
            :param limit: Limit of results to return. Default is 25.

            :return: Entry Context with all phishing submissions found.
            """
            args = {'priority_event_score': priority_event_score,
                    'status': status,
                    'page_size': limit,
                    'from_time': Utils.date_to_unix(from_time) if from_time else None,
                    'to_time': Utils.date_to_unix(to_time) if to_time else None}
            response = self.client.get_phishing_submissions_page(**args)  # pylint: disable=E1123
            if not response.items:
                return 'No phishing submissions were found.'

            submissions, ec = self.context_manager.translate_triage_submission(response.items)
            title = 'TruSTAR phishing triage submissions'
            entry = self.get_entry(title, submissions, ec)
            return entry

        def set_triage_status(self, submission_id=None, status=None):
            """
            Marks a phishing email submission with one of the phishing namespace.

            :param submission_id: Phishing Submission ID.
            :param status: Submission status.

            :return: Request status message.
            """
            try:
                response = self.client.mark_triage_status(submission_id, status)
                response.raise_for_status()
                return f'Submission ID {submission_id} is {status}'
            except requests.exceptions.HTTPError as err:
                return str(err)

        def process(self, command, **kwargs):
            """
            Processes the command that the user has selected. Retrieves the params and converts
            them to the methods params syntax. Then makes the call to the helper method of the
            corresponding command and return the results. It puts data on the corresponding context and
            it also shows the data on the War room.
            """
            func = self.command_dict.get(command)
            args = {k.replace("-", "_"): v for k, v in kwargs.items()}
            list_args = {k: argToList(v) for k, v in args.items() if k in self.LIST_ARGS}
            args.update(list_args)
            result = func(**args)
            return return_results(result)


    def main():
        """ PARSE AND VALIDATE INTEGRATION PARAMS """

        server = demisto.params().get('server')
        station = demisto.params().get('station')
        api_key = str(demisto.params().get('key'))
        api_secret = str(demisto.params().get('secret'))
        base_url = server + '/api/1.3' if server else None
        insecure = not demisto.params().get('insecure', False)

        LOG(f'command is {demisto.command()}')

        config = {
            'user_api_key': api_key,
            'user_api_secret': api_secret,
            'api_endpoint': base_url,
            'verify': insecure,
            'client_type': "Python_SDK",
            'client_metatag': "demisto-xsoar"
        }

        try:
            client = TrustarClient(config, station)
            client.process(demisto.command(), **demisto.args())

        except requests.exceptions.HTTPError as e:
            if e.response.status_code == 401:
                return_error("Invalid Credentials. Please check your API Key and "
                             "Secret are correct on TruSTAR Station. Settings > API")

            return_error(f'Failed to execute {demisto.command()} command. Error: {str(e)}')

        except Exception as e:
            return_error(f'Failed to execute {demisto.command()} command. Error: {str(e)}')


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()

    register_module_line('TruSTAR v2', 'end', __line__())
  subtype: python3
  type: python
system: true
